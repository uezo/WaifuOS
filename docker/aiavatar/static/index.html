<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaifuOS WebSocket Example</title>
    <style>
        body {
            background-color: #121212;
            color: #E0E0E0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            color: #FFFFFF;
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin: 0 0 20px 0;
        }

        .avatar-frame {
            display: inline-block;
            background: linear-gradient(45deg, #FF007F, #7F00FF);
            border-radius: 50%;
            padding: 4px;
            transition: background 0.3s ease;
            margin: 20px auto;
            max-width: 90vw;
            max-height: 90vw;
            visibility: hidden;
        }

        .avatar-container {
            background: #000;
            border-radius: 50%;
            width: 100%;
            height: 100%;
            max-width: 480px;
            max-height: 480px;
            width: 320px;
            height: 320px;
            aspect-ratio: 1;
            overflow: hidden;
        }

        #faceImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .button-container {
            margin: 20px 0;
        }

        button {
            background-color: #1E1E1E;
            border: none;
            padding: 12px 24px;
            color: #E0E0E0;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            min-height: 44px;
        }

        button:hover {
            background-color: #333333;
        }
    </style>
</head>

<body>
    <h1>WaifuOS WebSocket Example</h1>

    <div class="avatar-frame" id="avatarFrame">
        <div class="avatar-container">
            <img id="faceImage" alt="Avatar Face">
        </div>
    </div>

    <div class="button-container">
        <button id="startBtn" disabled>Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="interruptToggleBtn">Interrupt Speech: OFF</button>
    </div>
    
    <div class="input-level">
        <span style="color: #E0E0E0;">Input: </span>
        <span id="inputLevel">0.0 dB</span>
    </div>

    <script src="aiavatar.js"></script>
    <script>
        const sessionId = crypto.randomUUID();
        let userId = null;
        let contextId = null;
        let waifuId = null;
        let waifuIconDataUrl = null;

        const initChat = async () =>
        {
            // Get waifu
            const waifuResponse = await fetch(`../api/waifu`);
            if (!waifuResponse.ok) {
                throw new Error(`Waifu request failed with status ${waifuResponse.status}`);
            }
            const waifuData = await waifuResponse.json();
            waifuId = waifuData.waifu_id ?? null;
            console.log(`Current waifuId: ${waifuId}`);
            waifuIconDataUrl = `data:image/png;base64,${waifuData.waifu_image}`;

            // User
            const storageKey = "userId";
            const stored = localStorage.getItem(storageKey);
            if (stored) {
                userId = stored;
                console.log(`userId (stored): ${userId}`);
            }

            // Get or create user
            let userUrl = "../api/user";
            if (userId)
            {
                userUrl += `?user_id=${encodeURIComponent(userId)}`;
            }
            const userResponse = await fetch(userUrl);
            if (!userResponse.ok) {
                throw new Error(`User request failed with status ${userResponse.status}`);
            }
            const userData = await userResponse.json();
            userId = userData.user_id ?? null;
            localStorage.setItem(storageKey, userId);
            console.log(`userId (server): ${userId}`);

            // Get context
            const contextResponse = await fetch(`../api/context?user_id=${encodeURIComponent(userId)}`);
            if (!contextResponse.ok) {
                throw new Error(`Context request failed with status ${contextResponse.status}`);
            }
            const contextData = await contextResponse.json();
            contextId = contextData.context_id ?? null;
            console.log(`contextId: ${contextId}`);

            document.getElementById("startBtn").disabled = false;
            document.getElementById("stopBtn").disabled = false;
        }

        initChat().then(() => {
            const faceImage = document.getElementById("faceImage");
            faceImage.src = waifuIconDataUrl;
            faceImage.decode().then(() => {
                const avatarContainer = document.getElementById("avatarFrame");
                avatarContainer.style.width = "320px";
                avatarContainer.style.height = "320px";
                avatarContainer.style.visibility = "visible";
            });

            // Create AIAvatar
            const aiavatar = new AIAvatarClient({
                webSocketUrl: "../ws/connect",
                faceImage: document.getElementById("faceImage"),
                faceImagePaths: {
                    neutral: waifuIconDataUrl,
                    joy: waifuIconDataUrl,
                    angry: waifuIconDataUrl,
                    sorrow: waifuIconDataUrl,
                    fun: waifuIconDataUrl,
                    surprised: waifuIconDataUrl,
                    think: waifuIconDataUrl,
                }
            });

            // Example: Show microphone effect and input level
            const avatarFrame = document.getElementById("avatarFrame");
            const inputLevelElement = document.getElementById("inputLevel");
            let rmsSum = 0;
            let rmsCount = 0;
            let lastUpdateTime = Date.now();
            
            aiavatar.onMicrophoneDataSend = (rms) => {
                if (rms > 0.01) {
                    avatarFrame.style.background = "linear-gradient(45deg, #FF0000, #FF7F00)";
                } else {
                    avatarFrame.style.background = "linear-gradient(45deg, #FF007F, #7F00FF)";
                }
                
                // Accumulate RMS values for averaging
                rmsSum += rms;
                rmsCount++;
                
                // Update display every 0.5 seconds with average
                const currentTime = Date.now();
                if (currentTime - lastUpdateTime >= 500) {
                    const avgRms = rmsSum / rmsCount;
                    const dbLevel = avgRms > 0 ? 20 * Math.log10(avgRms) : -80;
                    inputLevelElement.textContent = `${dbLevel.toFixed(1)} dB`;
                    
                    // Reset for next interval
                    rmsSum = 0;
                    rmsCount = 0;
                    lastUpdateTime = currentTime;
                }
            }

            // Custom response handling
            aiavatar.onResponseReceived = (response) => {
                // Example: Show thinking effect while server is processing
                if (response.type == "start") {
                    aiavatar.updateFace("think", 10);
                } else if (response.type == "chunk" && response.metadata.is_first_chunk) {
                    aiavatar.updateFace("neutral", 0);
                } else if (response.type == "tool_call") {
                    console.log(response.metadata);
                }

                // Example: Show user and AI's message in UI
                if (response.metadata && response.metadata.request_text) {
                    // document.getElementById("user-balloon").innerText = response.metadata.request_text;
                }
                if (response.voice_text) {
                    // document.getElementById("ai-balloon").innerText = response.voice_text;
                }
            }

            // Interrupt toggle functionality
            let interruptEnabled = false;
            const interruptToggleBtn = document.getElementById("interruptToggleBtn");
            
            interruptToggleBtn.addEventListener("click", () => {
                interruptEnabled = !interruptEnabled;
                aiavatar.cancelEcho = !interruptEnabled;
                interruptToggleBtn.textContent = interruptEnabled ? "Interrupt Speech: ON" : "Interrupt Speech: OFF";
                interruptToggleBtn.style.backgroundColor = interruptEnabled ? "#2E7D32" : "#1E1E1E";
            });

            // Start and stop buttons
            document.getElementById("startBtn").addEventListener("click", () => aiavatar.startListening(sessionId, userId, contextId));
            document.getElementById("stopBtn").addEventListener("click", () => aiavatar.stopListening(sessionId));
        });
    </script>
</body>

</html>
